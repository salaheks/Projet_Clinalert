<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataSeeder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">doctortracker-backend</a> &gt; <a href="index.source.html" class="el_package">com.clinalert.doctortracker.util</a> &gt; <span class="el_source">DataSeeder.java</span></div><h1>DataSeeder.java</h1><pre class="source lang-java linenums">package com.clinalert.doctortracker.util;

import com.clinalert.doctortracker.model.Alert;
import com.clinalert.doctortracker.model.Doctor;
import com.clinalert.doctortracker.model.Measurement;
import com.clinalert.doctortracker.model.Patient;
import com.clinalert.doctortracker.repository.AlertRepository;
import com.clinalert.doctortracker.repository.DoctorRepository;
import com.clinalert.doctortracker.repository.MeasurementRepository;
import com.clinalert.doctortracker.repository.PatientRepository;
import org.springframework.boot.CommandLineRunner;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

// @Component - Temporarily disabled to avoid conflict with AuthDataSeeder
public class DataSeeder implements CommandLineRunner {

<span class="fc" id="L23">    private static final Logger logger = LoggerFactory.getLogger(DataSeeder.class);</span>

    private final MeasurementRepository measurementRepository;
    private final DoctorRepository doctorRepository;
    private final PatientRepository patientRepository;
    private final AlertRepository alertRepository;

    public DataSeeder(MeasurementRepository measurementRepository,
            DoctorRepository doctorRepository,
            PatientRepository patientRepository,
<span class="fc" id="L33">            AlertRepository alertRepository) {</span>
<span class="fc" id="L34">        this.measurementRepository = measurementRepository;</span>
<span class="fc" id="L35">        this.doctorRepository = doctorRepository;</span>
<span class="fc" id="L36">        this.patientRepository = patientRepository;</span>
<span class="fc" id="L37">        this.alertRepository = alertRepository;</span>
<span class="fc" id="L38">    }</span>

    @Override
    public void run(String... args) throws Exception {
<span class="fc" id="L42">        List&lt;Doctor&gt; doctors = seedDoctors();</span>
<span class="fc" id="L43">        List&lt;Patient&gt; patients = seedPatients(doctors);</span>
<span class="fc" id="L44">        List&lt;Measurement&gt; measurements = seedMeasurements(patients);</span>
<span class="fc" id="L45">        seedAlerts(measurements);</span>
<span class="fc" id="L46">        logSummary();</span>
<span class="fc" id="L47">    }</span>

    private List&lt;Doctor&gt; seedDoctors() {
<span class="fc bfc" id="L50" title="All 2 branches covered.">        if (doctorRepository.count() &gt; 0) {</span>
<span class="fc" id="L51">            return doctorRepository.findAll();</span>
        }

<span class="fc" id="L54">        logger.info(&quot;Seeding doctors...&quot;);</span>
<span class="fc" id="L55">        Doctor d1 = new Doctor();</span>
<span class="fc" id="L56">        d1.setName(&quot;Dr. Gregory House&quot;);</span>
<span class="fc" id="L57">        d1.setSpecialty(&quot;Diagnostic Medicine&quot;);</span>
<span class="fc" id="L58">        d1.setEmail(&quot;house@clinalert.com&quot;);</span>
<span class="fc" id="L59">        d1.setPhoneNumber(&quot;555-0101&quot;);</span>

<span class="fc" id="L61">        Doctor d2 = new Doctor();</span>
<span class="fc" id="L62">        d2.setName(&quot;Dr. Allison Cameron&quot;);</span>
<span class="fc" id="L63">        d2.setSpecialty(&quot;Immunology&quot;);</span>
<span class="fc" id="L64">        d2.setEmail(&quot;cameron@clinalert.com&quot;);</span>
<span class="fc" id="L65">        d2.setPhoneNumber(&quot;555-0102&quot;);</span>

<span class="fc" id="L67">        List&lt;Doctor&gt; doctors = doctorRepository.saveAll(new ArrayList&lt;&gt;(List.of(d1, d2)));</span>
<span class="fc" id="L68">        logger.info(&quot;✓ Doctors seeded: {}&quot;, doctors.size());</span>
<span class="fc" id="L69">        return doctors;</span>
    }

    private List&lt;Patient&gt; seedPatients(List&lt;Doctor&gt; doctors) {
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (patientRepository.count() &gt; 0) {</span>
<span class="fc" id="L74">            return patientRepository.findAll();</span>
        }

<span class="fc" id="L77">        logger.info(&quot;Seeding patients...&quot;);</span>
<span class="fc" id="L78">        String doctor1Id = doctors.get(0).getId();</span>
<span class="fc" id="L79">        String doctor2Id = doctors.get(1).getId();</span>

<span class="fc" id="L81">        Patient p1 = createPatient(&quot;Jean Dupont&quot;, 45, &quot;M&quot;, doctor1Id, AppConstants.STATUS_ACTIVE);</span>
<span class="fc" id="L82">        Patient p2 = createPatient(&quot;Marie Martin&quot;, 62, &quot;F&quot;, doctor1Id, AppConstants.STATUS_ACTIVE);</span>
<span class="fc" id="L83">        Patient p3 = createPatient(&quot;Pierre Bernard&quot;, 38, &quot;M&quot;, doctor2Id, AppConstants.STATUS_TRANSFERRED);</span>
<span class="fc" id="L84">        Patient p4 = createPatient(&quot;Sophie Dubois&quot;, 55, &quot;F&quot;, doctor2Id, AppConstants.STATUS_ACTIVE);</span>
<span class="fc" id="L85">        Patient p5 = createPatient(&quot;Luc Moreau&quot;, 71, &quot;M&quot;, doctor1Id, AppConstants.STATUS_DISCHARGED);</span>

<span class="fc" id="L87">        List&lt;Patient&gt; patients = patientRepository.saveAll(new ArrayList&lt;&gt;(List.of(p1, p2, p3, p4, p5)));</span>
<span class="fc" id="L88">        logger.info(&quot;✓ Patients seeded: {}&quot;, patients.size());</span>
<span class="fc" id="L89">        return patients;</span>
    }

    private Patient createPatient(String name, int age, String gender, String doctorId, String status) {
<span class="fc" id="L93">        Patient p = new Patient();</span>
<span class="fc" id="L94">        p.setName(name);</span>
<span class="fc" id="L95">        p.setAge(age);</span>
<span class="fc" id="L96">        p.setGender(gender);</span>
<span class="fc" id="L97">        p.setDoctorId(doctorId);</span>
<span class="fc" id="L98">        p.setStatus(status);</span>
<span class="fc" id="L99">        return p;</span>
    }

    private List&lt;Measurement&gt; seedMeasurements(List&lt;Patient&gt; patients) {
<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (measurementRepository.count() &gt; 0) {</span>
<span class="fc" id="L104">            return measurementRepository.findAll();</span>
        }

<span class="fc" id="L107">        logger.info(&quot;Seeding measurements...&quot;);</span>
<span class="fc" id="L108">        List&lt;Measurement&gt; measurements = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">        for (Patient patient : patients) {</span>
<span class="fc" id="L111">            String patientId = patient.getId();</span>

            // Heart rate
<span class="fc" id="L114">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_HEART_RATE, 72.0, 30));</span>
<span class="fc" id="L115">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_HEART_RATE, 75.0, 25));</span>
<span class="fc" id="L116">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_HEART_RATE,</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">                    patient.getAge() &gt; 60 ? 95.0 : 78.0, 20));</span>

            // Temperature
<span class="fc" id="L120">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_TEMPERATURE, 36.6, 15));</span>
<span class="fc" id="L121">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_TEMPERATURE,</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">                    patient.getName().contains(&quot;Marie&quot;) ? 38.2 : 36.8, 10));</span>

            // Blood pressure
<span class="fc" id="L125">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_BLOOD_PRESSURE,</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">                    patient.getAge() &gt; 60 ? 145.0 : 120.0, 8));</span>

            // Oxygen saturation
<span class="fc" id="L129">            measurements.add(createMeasurement(patientId, AppConstants.MEASUREMENT_TYPE_OXYGEN_SATURATION,</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">                    patient.getAge() &gt; 65 ? 92.0 : 98.0, 5));</span>
<span class="fc" id="L131">        }</span>

<span class="fc" id="L133">        measurements = measurementRepository.saveAll(measurements);</span>
<span class="fc" id="L134">        logger.info(&quot;✓ Measurements seeded: {}&quot;, measurements.size());</span>
<span class="fc" id="L135">        return measurements;</span>
    }

    private void seedAlerts(List&lt;Measurement&gt; measurements) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (alertRepository.count() &gt; 0) {</span>
<span class="fc" id="L140">            return;</span>
        }

<span class="fc" id="L143">        logger.info(&quot;Seeding alerts...&quot;);</span>
<span class="fc" id="L144">        List&lt;Alert&gt; alerts = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        for (Measurement m : measurements) {</span>
<span class="nc" id="L147">            Alert alert = checkMeasurementForAlert(m);</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            if (alert != null) {</span>
<span class="nc" id="L149">                alerts.add(alert);</span>
            }
<span class="nc" id="L151">        }</span>

<span class="fc" id="L153">        alertRepository.saveAll(alerts);</span>
<span class="fc" id="L154">        logger.info(&quot;✓ Alerts seeded: {}&quot;, alerts.size());</span>
<span class="fc" id="L155">    }</span>

    private Alert checkMeasurementForAlert(Measurement m) {
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (m.getType().equals(AppConstants.MEASUREMENT_TYPE_HEART_RATE)) {</span>
<span class="fc" id="L159">            return checkHeartRateAlert(m);</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        } else if (m.getType().equals(AppConstants.MEASUREMENT_TYPE_TEMPERATURE)) {</span>
<span class="nc" id="L161">            return checkTemperatureAlert(m);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        } else if (m.getType().equals(AppConstants.MEASUREMENT_TYPE_BLOOD_PRESSURE)) {</span>
<span class="fc" id="L163">            return checkBloodPressureAlert(m);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        } else if (m.getType().equals(AppConstants.MEASUREMENT_TYPE_OXYGEN_SATURATION)) {</span>
<span class="nc" id="L165">            return checkOxygenAlert(m);</span>
        }
<span class="fc" id="L167">        return null;</span>
    }

    private Alert checkHeartRateAlert(Measurement m) {
<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (m.getValue() &gt; 90) {</span>
<span class="fc" id="L172">            return createAlert(m.getPatientId(), m.getId(),</span>
<span class="fc" id="L173">                    &quot;Rythme cardiaque élevé détecté: &quot; + m.getValue() + &quot; bpm&quot;,</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">                    m.getValue() &gt; 100 ? AppConstants.ALERT_SEVERITY_HIGH : AppConstants.ALERT_SEVERITY_MEDIUM);</span>
        }
<span class="fc" id="L176">        return null;</span>
    }

    private Alert checkTemperatureAlert(Measurement m) {
<span class="fc bfc" id="L180" title="All 2 branches covered.">        if (m.getValue() &gt; 37.5) {</span>
<span class="fc" id="L181">            return createAlert(m.getPatientId(), m.getId(),</span>
<span class="fc" id="L182">                    &quot;Température élevée détectée: &quot; + m.getValue() + &quot;°C&quot;,</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                    m.getValue() &gt; 38.0 ? AppConstants.ALERT_SEVERITY_HIGH : AppConstants.ALERT_SEVERITY_MEDIUM);</span>
        }
<span class="fc" id="L185">        return null;</span>
    }

    private Alert checkBloodPressureAlert(Measurement m) {
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (m.getValue() &gt; 140) {</span>
<span class="fc" id="L190">            return createAlert(m.getPatientId(), m.getId(),</span>
<span class="fc" id="L191">                    &quot;Pression artérielle élevée: &quot; + m.getValue() + &quot; mmHg&quot;,</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">                    m.getValue() &gt; 160 ? AppConstants.ALERT_SEVERITY_CRITICAL : AppConstants.ALERT_SEVERITY_HIGH);</span>
        }
<span class="fc" id="L194">        return null;</span>
    }

    private Alert checkOxygenAlert(Measurement m) {
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (m.getValue() &lt; 95) {</span>
<span class="fc" id="L199">            return createAlert(m.getPatientId(), m.getId(),</span>
<span class="fc" id="L200">                    &quot;Saturation en oxygène faible: &quot; + m.getValue() + &quot;%&quot;,</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">                    m.getValue() &lt; 90 ? AppConstants.ALERT_SEVERITY_CRITICAL : AppConstants.ALERT_SEVERITY_MEDIUM);</span>
        }
<span class="fc" id="L203">        return null;</span>
    }

    private void logSummary() {
<span class="fc" id="L207">        logger.info(&quot;=================================&quot;);</span>
<span class="fc" id="L208">        logger.info(&quot;Database seeding completed!&quot;);</span>
<span class="fc" id="L209">        logger.info(&quot;Doctors: {}&quot;, doctorRepository.count());</span>
<span class="fc" id="L210">        logger.info(&quot;Patients: {}&quot;, patientRepository.count());</span>
<span class="fc" id="L211">        logger.info(&quot;Measurements: {}&quot;, measurementRepository.count());</span>
<span class="fc" id="L212">        logger.info(&quot;Alerts: {}&quot;, alertRepository.count());</span>
<span class="fc" id="L213">        logger.info(&quot;=================================&quot;);</span>
<span class="fc" id="L214">    }</span>

    private Measurement createMeasurement(String patientId, String type, Double value, int minutesAgo) {
<span class="fc" id="L217">        Measurement m = new Measurement();</span>
<span class="fc" id="L218">        m.setPatientId(patientId);</span>
<span class="fc" id="L219">        m.setDeviceId(&quot;device-001&quot;);</span>
<span class="fc" id="L220">        m.setType(type);</span>
<span class="fc" id="L221">        m.setValue(value);</span>
<span class="fc" id="L222">        m.setTimestamp(LocalDateTime.now().minusMinutes(minutesAgo));</span>
<span class="fc" id="L223">        m.setReceivedAt(LocalDateTime.now().minusMinutes(minutesAgo));</span>
<span class="fc" id="L224">        return m;</span>
    }

    private Alert createAlert(String patientId, String measurementId, String message, String severity) {
<span class="fc" id="L228">        Alert alert = new Alert();</span>
<span class="fc" id="L229">        alert.setPatientId(patientId);</span>
<span class="fc" id="L230">        alert.setMeasurementId(measurementId);</span>
<span class="fc" id="L231">        alert.setMessage(message);</span>
<span class="fc" id="L232">        alert.setSeverity(severity);</span>
<span class="fc" id="L233">        return alert;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>